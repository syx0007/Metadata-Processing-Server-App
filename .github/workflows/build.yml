name: Build Music Metadata Processor - Windows Only

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'Manual trigger'
  push:
    tags: ['v*']

jobs:
  build-windows:
    strategy:
      matrix:
        include:
          - architecture: x86
            target: x86
            python_version: '3.10'
          - architecture: x64
            target: x64
            python_version: '3.10'

    runs-on: windows-latest
    name: Build Windows ${{ matrix.target }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python_version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python_version }}
        architecture: ${{ matrix.architecture }}

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller==6.15.0 flask==3.1.2 mutagen==1.47.0 requests==2.32.5 flask_cors==4.0.0
        pip install "pyside6==6.6.1" --timeout=1000 --retries=3 --trusted-host files.pythonhosted.org

    - name: Verify PySide6 installation
      run: |
        python -c "import PySide6; print(f'PySide6 version: {PySide6.__version__}')"

    - name: Create icon file if missing
      run: |
        if (-not (Test-Path "icon.ico")) {
          echo "Creating placeholder icon..."
          # åˆ›å»ºä¸€ä¸ªæœ‰æ•ˆçš„ICOæ–‡ä»¶å ä½ç¬¦
          $iconContent = [byte[]]@(0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x10, 0x00, 0x00, 0x01, 0x00, 0x20, 0x00, 0x68, 0x04, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00)
          [System.IO.File]::WriteAllBytes("icon.ico", $iconContent)
        }

    - name: Build Windows executable
      run: |
        $buildName = "MusicMetadataProcessor_windows_${{ matrix.target }}"
        
        # æ˜¾ç¤ºå½“å‰ç›®å½•ç»“æ„ç”¨äºè°ƒè¯•
        Get-ChildItem .
        
        python -m PyInstaller `
          --onefile `
          --windowed `
          --name $buildName `
          --icon=icon.ico `
          --add-data "icon.ico;." `
          --hidden-import=flask `
          --hidden-import=flask_cors `
          --hidden-import=mutagen `
          --hidden-import=requests `
          --hidden-import=PySide6 `
          --hidden-import=PySide6.QtCore `
          --hidden-import=PySide6.QtGui `
          --hidden-import=PySide6.QtWidgets `
          --clean `
          --noconfirm `
          app_gui.py

        if (Test-Path "dist/$buildName.exe") {
          echo "âœ… Windows ${{ matrix.target }} build successful!"
          echo "File size: $( (Get-Item "dist/$buildName.exe").Length ) bytes"
        } else {
          echo "âŒ Build failed - checking dist directory:"
          Get-ChildItem "dist" -ErrorAction SilentlyContinue
          exit 1
        }

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-${{ matrix.target }}-build
        path: dist/
        if-no-files-found: error

  create-release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: List all artifacts
      run: |
        echo "Available artifacts:"
        find artifacts -type f -name "*" | while read file; do
          echo "  - $file"
          ls -la "$file"
        done

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/**/*
        body: |
          # ğŸµ éŸ³ä¹å…ƒæ•°æ®å¤„ç†å™¨ - Windows ç‰ˆæœ¬

          ## ğŸ“¦ ä¸‹è½½è¯´æ˜

          ### Windows ç³»ç»Ÿ
          - **x86 (32ä½)**: `MusicMetadataProcessor_windows_x86.exe`
          - **x64 (64ä½)**: `MusicMetadataProcessor_windows_x64.exe`

          ## ğŸš€ ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¯¹åº”çš„ `.exe` æ–‡ä»¶
          2. åŒå‡»è¿è¡Œå³å¯

          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡è¿è¡Œå¯èƒ½ä¼šè¢«Windows Defenderæ‹¦æˆªï¼Œè¯·é€‰æ‹©"æ›´å¤šä¿¡æ¯"->"ä»è¦è¿è¡Œ"
          - å»ºè®®ä¸‹è½½ä¸æ‚¨ç³»ç»Ÿæ¶æ„åŒ¹é…çš„ç‰ˆæœ¬

          ## ğŸ“Š ç‰ˆæœ¬ä¿¡æ¯
          - ç‰ˆæœ¬: ${{ github.ref_name }}
          - æ„å»ºæ—¶é—´: ${{ github.event.repository.updated_at }}
          - Pythonç‰ˆæœ¬: 3.10
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
